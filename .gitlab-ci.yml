stages:
  - ðŸ lint
  - ðŸ¤ž test
  - ðŸ“¦ build
  - ðŸš€ deploy

variables:
  PYTHON_DOCKER_IMAGE: python:3.12-slim-bookworm
  SFCGAL_REGISTRY: registry.gitlab.com/sfcgal/sfcgal

lint:flake8:
  stage: ðŸ lint
  image: ${PYTHON_DOCKER_IMAGE}
  only:
    refs:
      - merge_requests
      - master
    changes:
      - "pysfcgal/*.py"
      - "tests/*.py"
      - ".gitlab-ci.yml"
  before_script:
    - python -m pip install --force-reinstall flake8==7.1.1
  script:
    - flake8 pysfcgal/ tests/ --config=setup.cfg

lint:commit:
  stage: ðŸ lint
  image: ${PYTHON_DOCKER_IMAGE}
  before_script:
    - apt-get update && apt-get install -y git
    - pip install commitizen
  script:
    - cz check --rev-range $CI_MERGE_REQUEST_DIFF_BASE_SHA..HEAD
  only:
    refs:
      - merge_requests

lint:mypy:
  stage: ðŸ lint
  image: ${PYTHON_DOCKER_IMAGE}
  only:
    refs:
      - merge_requests
      - master
    changes:
      - "pysfcgal/*.py"
      - ".gitlab-ci.yml"
  before_script:
    - python -m pip install -U mypy types-cffi typing-extensions
  script:
    - mypy pysfcgal/

test:unit:
  stage: ðŸ¤ž test
  image: ${SFCGAL_REGISTRY}:debian-latest
  only:
    refs:
      - merge_requests
      - master
    changes:
      - "pysfcgal/*.py"
      - "tests/*.py"
      - ".gitlab-ci.yml"
  before_script:
    - apt install --no-install-recommends --yes python3 python3-pip python3-dev python3-venv gcc
    - python3 -m venv venv
    - source venv/bin/activate
    - python3 -m pip install -U pytest pytest-cov
    - pip install -e .
    - python3 -m pip install icontract
  script:
    - pytest --junitxml=junit/test-results-unit.xml --cov pysfcgal --cov-report=xml:coverage-reports/coverage-unit.xml
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage-reports/coverage-unit.xml
      junit:
        - junit/test-results-unit.xml

build:windows-osgeo4w-wheel:
  stage: ðŸ“¦ build
  tags:
    - saas-windows-medium-amd64
  rules:
    # on default branch
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      when: always
    # on a tag
    - if: $CI_COMMIT_TAG
      when: always
    # on a MR if previous jobs are successful
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: manual
      allow_failure: true
  artifacts:
    paths:
      - dist_windows
  script:
    # gitlab ci on widows does not handle the 'image' keyword
    # use docker build to be able to pull sfcgal/sfcgal-build-deps image
    - $env:dir = $pwd
    - docker run
      --rm
      --mount type=bind,source=$env:dir,target=c:\pysfcgal
      --workdir "c:\pysfcgal"
      $env:SFCGAL_REGISTRY':'windows-latest
      ".\ci\build.ps1"

build:linux-wheel-python:
  stage: ðŸ“¦ build
  image: docker:27.3
  services:
    - docker:27.3-dind
  rules:
    # on default branch
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      when: always
    # on a tag
    - if: $CI_COMMIT_TAG
      when: always
    # on a MR if previous jobs are successful
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: manual
      allow_failure: true
  variables:
    SFCGAL_REGISTRY: registry.gitlab.com/sfcgal/sfcgal
  parallel:
    matrix:
      - PYTHON_VERSION: ['3.9', '3.10', '3.11', '3.12']
  script:
    - docker build
      --tag build_linux_wheel
      --build-arg="SFCGAL_REGISTRY=${SFCGAL_REGISTRY}"
      --build-arg="PYTHON_WHEEL_VERSION=${PYTHON_VERSION}"
      -f "docker/Dockerfile_linux_wheel"
      .
    - CONTAINER_ID=$(docker run -d -t build_linux_wheel)
    - docker cp ${CONTAINER_ID}:/dist_linux_${PYTHON_VERSION}/ ./
    - docker stop ${CONTAINER_ID}
  artifacts:
    paths:
      - dist_linux_$PYTHON_VERSION

build:release_notes:
  stage: ðŸ“¦ build
  image: debian:bullseye-slim
  # rules:
  # - if: '$CI_COMMIT_TAG =~ /^v?\d+\.\d+\.\d+$/'
  rules:
    # on default branch
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: always
  script:
    - apt update && apt install --no-install-recommends -y ca-certificates curl jq
    - 'curl -H "PRIVATE-TOKEN: $CI_API_TOKEN" "$CI_API_V4_URL/projects/$CI_PROJECT_ID/repository/changelog?version=$CI_COMMIT_TAG" | jq -r .notes > release_notes.md'
  artifacts:
    paths:
    - release_notes.md

deploy:pypi:
  stage: ðŸš€ deploy
  image: ${PYTHON_DOCKER_IMAGE}
  variables:
    TWINE_USERNAME: $TWINE_USERNAME
    TWINE_PASSWORD: $TWINE_PASSWORD
  rules:
    # on a tag
    - if: $CI_COMMIT_TAG
  needs:
    - job: build:windows-osgeo4w-wheel
      artifacts: true
    - job: build:linux-wheel-python
      artifacts: true
  before_script:
    - pip install twine
  script:
    - mkdir dist
    - cp -r dist_windows/* dist/
    - cp -r dist_linux_*/* dist/
    - twine upload dist/*

build:documentation:
  stage: ðŸ“¦ build
  image: ${PYTHON_DOCKER_IMAGE}
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "pysfcgal/*.py"
        - ".gitlab-ci.yml"
      when: on_success
    - when: never
  before_script:
    - python -m pip install -U pip
    - python -m pip install -U -r requirements/documentation.txt
  script:
    - export PYTHONPATH=$(pwd)
    - cd docs && mkdocs build --verbose --strict
  artifacts:
    name: documentation
    expose_as: "built_documentation"
    paths:
      - docs/site
    when: always

# -- DEPLOYMENT JOBS ------------
pages:
  stage: ðŸš€ deploy
  only:
    refs:
      - master
  needs:
    - job: build:documentation
      artifacts: true
  variables:
    GIT_STRATEGY: none
  script:
    - mkdir -p public
    - cp -rf docs/site/* public/
  artifacts:
    paths:
      - public

deploy:release:
  stage: ðŸš€ deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build:release_notes
      artifacts: true
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v?\d+\.\d+\.\d+$/'
  script:
    - echo "running release_job"
  release:
    name: 'Release $CI_COMMIT_TAG'
    description: release_notes.md
    tag_name: '$CI_COMMIT_TAG'
